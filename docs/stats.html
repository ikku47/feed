<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stats - Factory Feed</title>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    :root {
      --bg: #fafafa;
      --card-bg: #ffffff;
      --sidebar-bg: #f6f6f6;
      --border: #eaeaea;
      --text: #000000;
      --text-secondary: #666666;
      --text-tertiary: #888888;
      --accent: #000000;
      --accent-fg: #ffffff;
      --hover: #f5f5f5;
      --selection: #e6f7ff;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      
      --twitter-color: #1d9bf0;
      --reddit-color: #ff4500;
      --github-color: #24292f;
      
      --sidebar-width: 240px;
    }

    [data-theme="dark"] {
      --bg: #000000;
      --card-bg: #0a0a0a;
      --sidebar-bg: #0a0a0a;
      --border: #333333;
      --text: #ffffff;
      --text-secondary: #a1a1a1;
      --text-tertiary: #666666;
      --accent: #ffffff;
      --accent-fg: #000000;
      --hover: #111111;
      --selection: #1a1a1a;
      --github-color: #ffffff;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      font-size: 14px;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .app-header {
      background: var(--card-bg);
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .app-logo {
      font-weight: 700;
      font-size: 16px;
      letter-spacing: -0.02em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .icon-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
      border-radius: 6px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.15s;
    }

    .icon-btn:hover {
      background: var(--hover);
      color: var(--text);
      border-color: var(--text-secondary);
    }

    .icon-btn svg {
      width: 16px;
      height: 16px;
    }

    .main-wrapper {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--sidebar-bg);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      transition: margin-left 0.2s ease;
      position: relative;
    }
    
    .sidebar.collapsed {
      margin-left: calc(-1 * var(--sidebar-width));
    }
    
    .sidebar-nav {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      display: flex;
      flex-direction: column;
    }
    
    .sidebar-sections {
      flex: 1;
    }
    
    .sidebar-section {
      margin-bottom: 24px;
    }
    
    .sidebar-commands-section {
      margin-top: auto;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    
    .sidebar-section-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-tertiary);
      padding: 8px 12px;
      margin-bottom: 4px;
    }
    
    .sidebar-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      color: var(--text-tertiary);
      cursor: pointer;
      transition: all 0.15s;
      text-decoration: none;
    }
    
    .sidebar-item:hover {
      background: var(--hover);
      color: var(--text);
    }
    
    .sidebar-item.active {
      background: var(--card-bg);
      font-weight: 500;
      color: var(--text);
    }
    
    .sidebar-item svg {
      width: 16px;
      height: 16px;
      color: var(--text-tertiary);
    }
    
    .sidebar-item.active svg {
      color: var(--text);
    }
    
    .sidebar-command {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 4px 12px;
      font-size: 13px;
      color: var(--text-tertiary);
    }
    
    .sidebar-command kbd {
      background: var(--card-bg);
      padding: 3px 6px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 11px;
      color: var(--text);
      border: 1px solid var(--border);
      min-width: 28px;
      text-align: center;
      font-weight: 500;
    }
    
    .sidebar-command span {
      flex: 1;
    }

    /* Secondary Nav */
    .secondary-nav {
      background: var(--card-bg);
      border-bottom: 1px solid var(--border);
      padding: 8px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
      gap: 16px;
    }
    
    .secondary-nav-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .nav-sidebar-toggle {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
      border-radius: 6px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .nav-sidebar-toggle:hover {
      background: var(--hover);
      color: var(--text);
    }
    
    .nav-sidebar-toggle svg {
      width: 16px;
      height: 16px;
    }
    
    .source-icons {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .source-icon-btn {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s;
    }
    
    .source-icon-btn:hover {
      background: var(--hover);
      color: var(--text);
    }
    
    .source-icon-btn.active {
      background: var(--text);
      color: var(--bg);
      border-color: var(--text);
    }
    
    .source-icon-btn svg {
      width: 14px;
      height: 14px;
    }
    
    .category-filters {
      display: flex;
      gap: 4px;
    }
    
    .category-filter-btn {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s;
    }
    
    .category-filter-btn:hover {
      background: var(--hover);
      color: var(--text);
    }
    
    .category-filter-btn.active {
      background: var(--text);
      color: var(--bg);
      border-color: var(--text);
    }
    
    .category-filter-btn svg {
      width: 14px;
      height: 14px;
    }

    /* Stats Content */
    .stats-container {
      flex: 1;
      overflow-y: auto;
      background: var(--card-bg);
      padding: 24px;
    }

    .stats-header {
      margin-bottom: 24px;
    }

    .stats-header h1 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .stats-header p {
      color: var(--text-secondary);
      font-size: 14px;
    }

    .filters {
      display: flex;
      gap: 12px;
      margin-bottom: 32px;
      flex-wrap: wrap;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .filter-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .filter-select {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
      cursor: pointer;
    }

    .filter-pills {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .filter-pill {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s;
    }
    
    .filter-pill:hover {
      background: var(--hover);
      color: var(--text);
    }
    
    .filter-pill.active {
      background: var(--text);
      color: var(--bg);
      border-color: var(--text);
    }
    
    .filter-pill svg {
      width: 14px;
      height: 14px;
    }

    .date-input {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
    }

    .stat-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .stat-card-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-card-icon {
      width: 16px;
      height: 16px;
      color: var(--text-secondary);
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .stat-subtitle {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .chart {
      margin-top: 24px;
    }

    .chart-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .chart-label {
      min-width: 120px;
      font-size: 13px;
      font-weight: 500;
    }

    .chart-bar-bg {
      flex: 1;
      height: 32px;
      background: var(--border);
      border-radius: 6px;
      position: relative;
      overflow: hidden;
    }

    .chart-bar-fill {
      height: 100%;
      background: var(--text);
      border-radius: 6px;
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      padding: 0 12px;
      color: var(--bg);
      font-size: 12px;
      font-weight: 600;
    }

    .chart-bar-fill.twitter { background: var(--twitter-color); }
    .chart-bar-fill.reddit { background: var(--reddit-color); }
    .chart-bar-fill.github { background: var(--github-color); }

    .list-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      border-bottom: 1px solid var(--border);
    }

    .list-item:last-child {
      border-bottom: none;
    }

    .list-item-name {
      font-weight: 500;
      font-size: 13px;
      color: var(--text);
      text-decoration: none;
      transition: color 0.15s;
    }
    
    .list-item-name:hover {
      color: var(--twitter-color);
    }

    .list-item-value {
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 600;
    }
    
    .weekly-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }
    
    .weekly-table th {
      text-align: left;
      padding: 12px;
      border-bottom: 2px solid var(--border);
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .weekly-table td {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
    }
    
    .weekly-table tr:hover {
      background: var(--hover);
    }
    
    .pagination-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 6px;
      padding: 6px 12px;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: all 0.15s;
      font-size: 13px;
      font-weight: 500;
    }
    
    .pagination-btn:hover {
      background: var(--hover);
      border-color: var(--text-secondary);
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: var(--text-secondary);
    }
  </style>
</head>
<body>
  <header class="app-header">
    <div class="app-logo">
      <i data-lucide="zap" style="width: 18px; height: 18px;"></i>
      <span>Factory Feed</span>
    </div>
    <button class="icon-btn" id="themeBtn" title="Toggle Theme">
      <i data-lucide="moon"></i>
    </button>
  </header>

  <nav class="secondary-nav">
    <div class="secondary-nav-left">
      <button class="nav-sidebar-toggle" id="navSidebarToggle">
        <i data-lucide="panel-left"></i>
      </button>
      
      <div class="source-icons">
        <button class="source-icon-btn active" data-source="all">
          <i data-lucide="layers"></i>
          <span>All</span>
        </button>
        <button class="source-icon-btn" data-source="twitter">
          <i data-lucide="twitter"></i>
        </button>
        <button class="source-icon-btn" data-source="reddit">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M6.167 8a.83.83 0 0 0-.83.83c0 .459.372.84.83.831a.831.831 0 0 0 0-1.661m1.843 3.647c.315 0 1.403-.038 1.976-.611a.23.23 0 0 0 0-.306.213.213 0 0 0-.306 0c-.353.363-1.126.487-1.67.487-.545 0-1.308-.124-1.671-.487a.213.213 0 0 0-.306 0 .213.213 0 0 0 0 .306c.564.563 1.652.61 1.977.61zm.992-2.807c0 .458.373.83.831.83s.83-.381.83-.83a.831.831 0 0 0-1.66 0z"/>
            <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.828-1.165c-.315 0-.602.124-.812.325-.801-.573-1.9-.945-3.121-.993l.534-2.501 1.738.372a.83.83 0 1 0 .83-.869.83.83 0 0 0-.744.468l-1.938-.41a.2.2 0 0 0-.153.028.2.2 0 0 0-.086.134l-.592 2.788c-1.24.038-2.358.41-3.17.992-.21-.2-.496-.324-.81-.324a1.163 1.163 0 0 0-.478 2.224q-.03.17-.029.353c0 1.795 2.091 3.256 4.669 3.256s4.668-1.451 4.668-3.256c0-.114-.01-.238-.029-.353.401-.181.688-.592.688-1.069 0-.65-.525-1.165-1.165-1.165"/>
          </svg>
        </button>
        <button class="source-icon-btn" data-source="github">
          <i data-lucide="github"></i>
        </button>
      </div>
      
      <div class="category-filters">
        <button class="category-filter-btn active" data-category="all" title="All">
          <i data-lucide="layers"></i>
          All
        </button>
        <button class="category-filter-btn" data-category="mention" title="Mentions">
          <i data-lucide="at-sign"></i>
          Mentions
        </button>
        <button class="category-filter-btn" data-category="bug" title="Bugs">
          <i data-lucide="bug"></i>
          Bugs
        </button>
        <button class="category-filter-btn" data-category="love" title="Love">
          <i data-lucide="heart"></i>
          Love
        </button>
        <button class="category-filter-btn" data-category="question" title="Questions">
          <i data-lucide="help-circle"></i>
          Questions
        </button>
      </div>
    </div>
  </nav>

  <div class="main-wrapper">
    <aside class="sidebar" id="sidebar">
      <nav class="sidebar-nav">
        <div class="sidebar-sections">
          <div class="sidebar-section">
            <div class="sidebar-section-title">Views</div>
            <a href="index.html" class="sidebar-item">
              <i data-lucide="inbox"></i>
              <span>All</span>
            </a>
            <a href="index.html#archived" class="sidebar-item">
              <i data-lucide="archive"></i>
              <span>Archived</span>
            </a>
            <a href="stats.html" class="sidebar-item active">
              <i data-lucide="bar-chart-3"></i>
              <span>Stats</span>
            </a>
          </div>
        </div>
        
        <div class="sidebar-section sidebar-commands-section">
          <div class="sidebar-section-title">Commands</div>
          <div class="sidebar-command">
            <kbd>← / →</kbd>
            <span>Toggle sidebar</span>
          </div>
        </div>
      </nav>
    </aside>

    <main class="stats-container" id="statsContainer">
      <div class="loading">Loading statistics...</div>
    </main>
  </div>

  <script>
    // Theme
    function setupTheme() {
      const themeBtn = document.getElementById('themeBtn');
      const stored = localStorage.getItem('theme');
      if (stored === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
      }

      themeBtn.addEventListener('click', () => {
        const current = document.documentElement.getAttribute('data-theme');
        const next = current === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
        
        const icon = next === 'dark' ? 'sun' : 'moon';
        themeBtn.innerHTML = `<i data-lucide="${icon}"></i>`;
        lucide.createIcons();
      });
    }

    // Sidebar
    function setupSidebar() {
      const sidebar = document.getElementById('sidebar');
      const toggle = document.getElementById('navSidebarToggle');
      
      toggle.addEventListener('click', () => {
        sidebar.classList.toggle('collapsed');
        localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
      });
      
      if (localStorage.getItem('sidebarCollapsed') === 'true') {
        sidebar.classList.add('collapsed');
      }

      // Keyboard shortcuts
      document.addEventListener('keydown', e => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        
        if (e.key === 'ArrowLeft') {
          sidebar.classList.add('collapsed');
          localStorage.setItem('sidebarCollapsed', 'true');
        } else if (e.key === 'ArrowRight') {
          sidebar.classList.remove('collapsed');
          localStorage.setItem('sidebarCollapsed', 'false');
        }
      });
    }

    // Stats
    let allData = [];
    let filteredData = [];
    let archivedIds = new Set();
    let currentFilters = {
      timeRange: 'all',
      source: 'all',
      category: 'all',
      startDate: null,
      endDate: null
    };

    async function loadData() {
      try {
        // Load feed data
        const res = await fetch('./data/feed.json');
        allData = await res.json();
        
        // Load archived items
        try {
          const archived = JSON.parse(localStorage.getItem('factoryArchivedIds') || '[]');
          archivedIds = new Set(archived);
        } catch (e) {
          console.error('Failed to load archived items:', e);
        }
        
        filteredData = allData;
        renderStats();
      } catch (err) {
        console.error('Failed to load data:', err);
        document.getElementById('statsContainer').innerHTML = '<div class="loading">Failed to load data</div>';
      }
    }

    function renderStats() {
      const container = document.getElementById('statsContainer');
      
      // Calculate stats
      const totalItems = filteredData.length;
      const archivedCount = filteredData.filter(item => archivedIds.has(item.id)).length;
      const bySource = {};
      const byAuthor = {};
      const byCategory = {};
      let totalEngagement = 0;
      
      filteredData.forEach(item => {
        // By source
        bySource[item.source] = (bySource[item.source] || 0) + 1;
        
        // By author
        byAuthor[item.author] = (byAuthor[item.author] || 0) + 1;
        
        // By category
        const cat = item.category || 'uncategorized';
        byCategory[cat] = (byCategory[cat] || 0) + 1;
        
        // Engagement
        if (item.metadata) {
          totalEngagement += (item.metadata.likes || 0) + 
                           (item.metadata.retweets || 0) + 
                           (item.metadata.replies || 0);
        }
      });
      
      const topAuthors = Object.entries(byAuthor)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);
      
      const maxSourceCount = Math.max(...Object.values(bySource));
      
      const dateRange = filteredData.length > 0 ? {
        oldest: new Date(Math.min(...filteredData.map(i => new Date(i.timestamp)))),
        newest: new Date(Math.max(...filteredData.map(i => new Date(i.timestamp))))
      } : null;
      
      const dateRangeText = dateRange ? 
        `${dateRange.oldest.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} - ${dateRange.newest.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}` 
        : 'No data';
      
      container.innerHTML = `
        <div class="filters">
          <div class="filter-group">
            <label class="filter-label">Time Range</label>
            <select class="filter-select" id="timeFilter">
              <option value="all">All Time</option>
              <option value="7">Last 7 Days</option>
              <option value="30">Last 30 Days</option>
              <option value="90">Last 90 Days</option>
              <option value="custom">Custom Range</option>
            </select>
          </div>
          <div class="filter-group" id="customDateGroup" style="display: none;">
            <label class="filter-label">Start Date</label>
            <input type="date" class="date-input" id="startDate">
          </div>
          <div class="filter-group" id="customDateGroup2" style="display: none;">
            <label class="filter-label">End Date</label>
            <input type="date" class="date-input" id="endDate">
          </div>
          <div class="filter-group">
            <label class="filter-label">&nbsp;</label>
            <div style="padding: 8px 12px; font-size: 13px; color: var(--text-secondary);">
              ${dateRangeText}
            </div>
          </div>
        </div>



        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-card-header">
              <span class="stat-card-title">Total Items</span>
              <i data-lucide="activity" class="stat-card-icon"></i>
            </div>
            <div class="stat-value">${totalItems.toLocaleString()}</div>
            <div class="stat-subtitle">${archivedCount} archived, ${totalItems - archivedCount} active</div>
          </div>

          <div class="stat-card">
            <div class="stat-card-header">
              <span class="stat-card-title">Total Engagement</span>
              <i data-lucide="heart" class="stat-card-icon"></i>
            </div>
            <div class="stat-value">${totalEngagement.toLocaleString()}</div>
            <div class="stat-subtitle">Likes, retweets, replies</div>
          </div>

          <div class="stat-card">
            <div class="stat-card-header">
              <span class="stat-card-title">Unique Authors</span>
              <i data-lucide="users" class="stat-card-icon"></i>
            </div>
            <div class="stat-value">${Object.keys(byAuthor).length.toLocaleString()}</div>
            <div class="stat-subtitle">Contributing to feed</div>
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-card-header">
              <span class="stat-card-title">Items by Source</span>
              <i data-lucide="pie-chart" class="stat-card-icon"></i>
            </div>
            <div class="chart">
              ${Object.entries(bySource).map(([source, count]) => `
                <div class="chart-bar">
                  <div class="chart-label">${source.charAt(0).toUpperCase() + source.slice(1)}</div>
                  <div class="chart-bar-bg">
                    <div class="chart-bar-fill ${source}" style="width: ${(count / maxSourceCount) * 100}%">
                      ${count}
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-card-header">
              <span class="stat-card-title">Top Authors</span>
              <i data-lucide="trophy" class="stat-card-icon"></i>
            </div>
            <div>
              ${topAuthors.map(([author, count]) => `
                <div class="list-item">
                  <a href="https://x.com/${author}" target="_blank" rel="noopener noreferrer" class="list-item-name">@${author}</a>
                  <span class="list-item-value">${count} posts</span>
                </div>
              `).join('')}
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-card-header">
              <span class="stat-card-title">By Category</span>
              <i data-lucide="tag" class="stat-card-icon"></i>
            </div>
            <div class="chart-container">
              ${Object.entries(byCategory).sort((a, b) => b[1] - a[1]).map(([cat, count]) => {
                const maxCount = Math.max(...Object.values(byCategory));
                const percentage = maxCount > 0 ? (count / maxCount) * 100 : 0;
                return `
                  <div class="chart-bar-row">
                    <span class="chart-bar-label">${cat.charAt(0).toUpperCase() + cat.slice(1)}</span>
                    <div class="chart-bar-wrapper">
                      <div class="chart-bar" style="width: ${percentage}%"></div>
                    </div>
                    <span class="chart-bar-value">${count}</span>
                  </div>
                `;
              }).join('')}
            </div>
          </div>



          <div class="stat-card" style="grid-column: 1 / -1;">
            <div class="stat-card-header">
              <span class="stat-card-title">Weekly Breakdown (Since Oct 13, 2024)</span>
              <div style="display: flex; gap: 8px; align-items: center;">
                <button class="pagination-btn" id="prevWeeks" style="display: none;">
                  <i data-lucide="chevron-left" style="width: 14px; height: 14px;"></i>
                  Previous
                </button>
                <button class="pagination-btn" id="nextWeeks" style="display: none;">
                  Next
                  <i data-lucide="chevron-right" style="width: 14px; height: 14px;"></i>
                </button>
                <i data-lucide="calendar" class="stat-card-icon"></i>
              </div>
            </div>
            <table class="weekly-table">
              <thead>
                <tr>
                  <th>Week Starting</th>
                  <th>Total</th>
                  <th>Twitter</th>
                  <th>Reddit</th>
                  <th>GitHub</th>
                  <th>Bugs</th>
                  <th>Love</th>
                </tr>
              </thead>
              <tbody id="weeklyTableBody">
              </tbody>
            </table>
          </div>
        </div>
      `;
      
      lucide.createIcons();
      setupFilters();
      setupWeeklyPagination();
    }
    
    let weeklyPage = 0;
    const weeksPerPage = 12;
    let allWeeklyStats = [];
    
    function generateWeeklyBreakdown() {
      // Start from Oct 13, 2024
      const startDate = new Date('2024-10-13');
      const now = new Date();
      const weeks = [];
      
      // Generate week ranges
      let currentWeekStart = new Date(startDate);
      while (currentWeekStart <= now) {
        const weekEnd = new Date(currentWeekStart);
        weekEnd.setDate(weekEnd.getDate() + 6);
        weekEnd.setHours(23, 59, 59, 999);
        
        weeks.push({
          start: new Date(currentWeekStart),
          end: weekEnd
        });
        
        currentWeekStart = new Date(weekEnd);
        currentWeekStart.setDate(currentWeekStart.getDate() + 1);
        currentWeekStart.setHours(0, 0, 0, 0);
      }
      
      // Calculate stats for each week
      allWeeklyStats = weeks.map(week => {
        const weekData = filteredData.filter(item => {
          const itemDate = new Date(item.timestamp);
          return itemDate >= week.start && itemDate <= week.end;
        });
        
        const stats = {
          date: week.start.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }),
          total: weekData.length,
          twitter: weekData.filter(i => i.source === 'twitter').length,
          reddit: weekData.filter(i => i.source === 'reddit').length,
          github: weekData.filter(i => i.source === 'github').length,
          bugs: weekData.filter(i => i.category === 'bug').length,
          love: weekData.filter(i => i.category === 'love').length
        };
        
        return stats;
      });
      
      // Reverse to show most recent first
      allWeeklyStats.reverse();
      
      // Update table with current page
      updateWeeklyTable();
    }
    
    function updateWeeklyTable() {
      const startIdx = weeklyPage * weeksPerPage;
      const endIdx = startIdx + weeksPerPage;
      const pageStats = allWeeklyStats.slice(startIdx, endIdx);
      
      const tbody = document.getElementById('weeklyTableBody');
      tbody.innerHTML = pageStats.map(stats => `
        <tr>
          <td>${stats.date}</td>
          <td><strong>${stats.total}</strong></td>
          <td>${stats.twitter}</td>
          <td>${stats.reddit}</td>
          <td>${stats.github}</td>
          <td>${stats.bugs}</td>
          <td>${stats.love}</td>
        </tr>
      `).join('');
      
      // Update pagination buttons
      const prevBtn = document.getElementById('prevWeeks');
      const nextBtn = document.getElementById('nextWeeks');
      
      if (prevBtn && nextBtn) {
        prevBtn.style.display = weeklyPage > 0 ? 'flex' : 'none';
        nextBtn.style.display = endIdx < allWeeklyStats.length ? 'flex' : 'none';
      }
      
      lucide.createIcons();
    }
    
    function setupWeeklyPagination() {
      const prevBtn = document.getElementById('prevWeeks');
      const nextBtn = document.getElementById('nextWeeks');
      
      if (prevBtn) {
        prevBtn.addEventListener('click', () => {
          if (weeklyPage > 0) {
            weeklyPage--;
            updateWeeklyTable();
          }
        });
      }
      
      if (nextBtn) {
        nextBtn.addEventListener('click', () => {
          if ((weeklyPage + 1) * weeksPerPage < allWeeklyStats.length) {
            weeklyPage++;
            updateWeeklyTable();
          }
        });
      }
    }

    function setupFilters() {
      const timeFilter = document.getElementById('timeFilter');
      const startDate = document.getElementById('startDate');
      const endDate = document.getElementById('endDate');
      
      // Time range selector
      timeFilter.addEventListener('change', (e) => {
        const customDateGroup = document.getElementById('customDateGroup');
        const customDateGroup2 = document.getElementById('customDateGroup2');
        
        if (e.target.value === 'custom') {
          customDateGroup.style.display = 'flex';
          customDateGroup2.style.display = 'flex';
        } else {
          customDateGroup.style.display = 'none';
          customDateGroup2.style.display = 'none';
        }
        
        currentFilters.timeRange = e.target.value;
        applyFilters();
      });
      
      // Custom date inputs
      startDate.addEventListener('change', (e) => {
        currentFilters.startDate = e.target.value;
        applyFilters();
      });
      
      endDate.addEventListener('change', (e) => {
        currentFilters.endDate = e.target.value;
        applyFilters();
      });
      
      // Source buttons in nav
      document.querySelectorAll('.source-icon-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.source-icon-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentFilters.source = btn.dataset.source;
          applyFilters();
        });
      });
      
      // Category buttons in nav
      document.querySelectorAll('.category-filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.category-filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentFilters.category = btn.dataset.category;
          applyFilters();
        });
      });
    }

    function applyFilters() {
      filteredData = allData.filter(item => {
        // Time filter
        if (currentFilters.timeRange === 'custom') {
          if (currentFilters.startDate) {
            const start = new Date(currentFilters.startDate);
            if (new Date(item.timestamp) < start) return false;
          }
          if (currentFilters.endDate) {
            const end = new Date(currentFilters.endDate);
            end.setHours(23, 59, 59, 999); // Include entire end date
            if (new Date(item.timestamp) > end) return false;
          }
        } else if (currentFilters.timeRange !== 'all') {
          const days = parseInt(currentFilters.timeRange);
          const cutoff = new Date();
          cutoff.setDate(cutoff.getDate() - days);
          if (new Date(item.timestamp) < cutoff) return false;
        }
        
        // Source filter
        if (currentFilters.source !== 'all' && item.source !== currentFilters.source) return false;
        
        // Category filter
        if (currentFilters.category !== 'all') {
          const cat = item.category || 'uncategorized';
          if (cat !== currentFilters.category) return false;
        }
        
        return true;
      });
      
      weeklyPage = 0; // Reset pagination when filters change
      renderStats();
    }

    // Init
    setupTheme();
    setupSidebar();
    loadData();
    lucide.createIcons();
  </script>
</body>
</html>
