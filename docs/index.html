<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Factory Feed</title>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    :root {
      --bg: #fafafa;
      --card-bg: #ffffff;
      --border: #eaeaea;
      --text: #000000;
      --text-secondary: #666666;
      --text-tertiary: #888888;
      --accent: #000000;
      --accent-fg: #ffffff;
      --hover: #f5f5f5;
      --selection: #e6f7ff;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      
      --twitter-color: #1d9bf0;
      --reddit-color: #ff4500;
      --github-color: #24292f;
    }

    [data-theme="dark"] {
      --bg: #000000;
      --card-bg: #0a0a0a;
      --border: #333333;
      --text: #ffffff;
      --text-secondary: #a1a1a1;
      --text-tertiary: #666666;
      --accent: #ffffff;
      --accent-fg: #000000;
      --hover: #111111;
      --selection: #1a1a1a;
      --github-color: #ffffff;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      font-size: 14px;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Layout */
    .app-header {
      background: var(--card-bg);
      border-bottom: 1px solid var(--border);
      padding: 12px 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      flex-shrink: 0;
      z-index: 20;
    }
    
    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .header-filters {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .main-wrapper {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .main-container {
      flex: 1;
      overflow: hidden;
      display: flex;
      position: relative;
      background: var(--bg);
    }

    /* Source Dropdown */
    .source-dropdown {
      position: relative;
    }
    
    .dropdown-trigger {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.15s;
    }
    
    .dropdown-trigger:hover {
      background: var(--hover);
    }
    
    .dropdown-menu {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 4px;
      min-width: 200px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
      display: none;
      z-index: 100;
    }
    
    .dropdown-menu.open {
      display: block;
    }
    
    .dropdown-item {
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: var(--text);
      transition: all 0.15s;
    }
    
    .dropdown-item:hover {
      background: var(--hover);
    }
    
    .dropdown-item-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .dropdown-checkbox {
      width: 16px;
      height: 16px;
      border: 2px solid var(--border);
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .dropdown-item.selected .dropdown-checkbox {
      background: var(--text);
      border-color: var(--text);
      color: var(--bg);
    }

    /* Hide card actions as requested */
    .card-actions {
      display: none !important;
    }

    .app-logo {
      font-weight: 700;
      font-size: 16px;
      letter-spacing: -0.02em;
      display: flex;
      align-items: center;
    }
    
    .app-logo-text {
      display: none;
    }

    /* Category Filter Pills */
    .category-filters {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    
    .category-filter-btn {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s;
    }
    
    .category-filter-btn:hover {
      background: var(--hover);
      color: var(--text);
    }
    
    .category-filter-btn.active {
      background: var(--text);
      color: var(--bg);
      border-color: var(--text);
    }
    
    .category-filter-btn svg {
      width: 14px;
      height: 14px;
    }

    /* Category Pills */
    .category-pill {
      padding: 4px 12px;
      border-radius: 99px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s;
      white-space: nowrap;
    }

    .category-pill:hover {
      background: var(--hover);
      color: var(--text);
    }

    .category-pill.active {
      background: var(--text);
      color: var(--bg);
      border-color: var(--text);
    }
    
    .category-pill .count {
        opacity: 0.7;
        font-size: 10px;
    }

    .app-controls {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .icon-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
      border-radius: 6px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.15s;
    }

    .icon-btn:hover {
      background: var(--hover);
      color: var(--text);
      border-color: var(--text-secondary);
    }

    .icon-btn svg {
      width: 16px;
      height: 16px;
    }

    /* Main Content */
    .main-container {
      flex: 1;
      overflow: hidden;
      display: flex;
      position: relative;
    }

    .feed-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      scroll-behavior: smooth;
    }

    .feed-list {
      max-width: 100%;
      margin: 0;
      display: flex;
      flex-direction: column;
      padding-bottom: 100px;
    }

    /* Cards */
    .card {
      background: transparent;
      border-bottom: 1px solid var(--border);
      padding: 12px 20px;
      padding-left: 50px; /* Space for checkbox */
      cursor: pointer;
      transition: all 0.15s ease;
      position: relative;
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 16px;
      min-height: 52px;
    }

    .card:hover {
      background: var(--hover);
    }

    .card.focused {
      background: var(--hover);
      z-index: 10;
      box-shadow: inset 2px 0 0 var(--text);
    }
    
    .card.selected {
      background: var(--selection);
    }

    .card.archived {
      opacity: 0.5;
      filter: grayscale(100%);
    }

    /* Checkbox */
    .card-checkbox {
      position: absolute;
      left: 16px;
      top: 16px;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.15s;
      color: transparent;
    }
    
    .card.selected .card-checkbox, .card-checkbox:hover {
        border-color: var(--text);
    }
    
    .card.selected .card-checkbox {
        background: var(--text);
        color: var(--bg);
    }
    
    .card-checkbox svg {
        width: 14px;
        height: 14px;
    }

    .card-source {
      flex-shrink: 0;
    }

    .card-content-wrapper {
      flex: 1;
      min-width: 0;
      overflow: hidden;
      margin-right: 75px;
    }

    .card-meta {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
      font-size: 13px;
      color: var(--text-secondary);
      margin-left: auto;
    }
    
    .card-username {
      display: flex;
      align-items: center;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text);
      white-space: nowrap;
    }
    
    .card-meta-item {
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .source-badge {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      border-radius: 4px;
    }
    
    .source-badge svg {
      width: 14px;
      height: 14px;
    }
    
    .source-twitter { color: var(--twitter-color); background: rgba(29, 155, 240, 0.1); }
    .source-reddit { color: var(--reddit-color); background: rgba(255, 69, 0, 0.1); }
    .source-github { color: var(--github-color); background: rgba(128, 128, 128, 0.1); }
    
    [data-theme="dark"] .source-github { background: rgba(255, 255, 255, 0.1); }

    .card-author {
      font-weight: 500;
      color: var(--text);
    }

    .card-time {
      color: var(--text-tertiary);
    }

    .card-content {
      color: var(--text);
      font-size: 14px;
      line-height: 1.5;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 1;
      -webkit-box-orient: vertical;
      white-space: normal;
    }

    .card-content a {
      color: var(--accent);
      text-decoration: underline;
      text-underline-offset: 2px;
    }
    
    .card-content img {
        display: none !important;
    }
    
    .card-engagement {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 12px;
      color: var(--text-tertiary);
    }
    
    .engagement-metric {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .engagement-metric svg {
      width: 13px;
      height: 13px;
    }

    .card-actions {
      margin-left: auto;
      display: flex;
      gap: 8px;
      opacity: 0;
      transition: opacity 0.15s;
    }

    .card:hover .card-actions, .card.focused .card-actions {
      opacity: 1;
    }

    .action-pill {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text-secondary);
    }
    
    .action-pill:hover {
      background: var(--text);
      color: var(--bg);
      border-color: var(--text);
    }

    /* Category Tags */
    .category-tag {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
    }
    
    .category-tag svg {
      width: 12px;
      height: 12px;
    }

    .category-mention { background: #e0e7ff; color: #4338ca; }
    .category-bug { background: #fee2e2; color: #dc2626; }
    .category-love { background: #dcfce7; color: #16a34a; }
    .category-question { background: #fef3c7; color: #d97706; }
    .category-other { background: var(--border); color: var(--text-secondary); }

    [data-theme="dark"] .category-mention { background: #312e81; color: #c7d2fe; }
    [data-theme="dark"] .category-bug { background: #7f1d1d; color: #fecaca; }
    [data-theme="dark"] .category-love { background: #14532d; color: #bbf7d0; }
    [data-theme="dark"] .category-question { background: #78350f; color: #fde68a; }

    /* Bulk Actions Bar */
    .bulk-actions-bar {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--card-bg);
      border: 1px solid var(--border);
      padding: 8px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      z-index: 50;
      transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }
    
    .bulk-actions-bar.visible {
      transform: translateX(-50%) translateY(0);
    }
    
    .bulk-selection-info {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
    }
    
    .bulk-count {
      font-weight: 600;
      font-size: 13px;
      color: var(--text);
    }
    
    .bulk-close {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      padding: 2px;
      border-radius: 4px;
    }
    
    .bulk-close:hover {
      background: var(--hover);
      color: var(--text);
    }
    
    .bulk-close svg {
      width: 14px;
      height: 14px;
    }
    
    .bulk-btn {
      background: var(--text);
      border: none;
      color: var(--bg);
      font-weight: 500;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 6px;
      transition: opacity 0.15s;
    }
    
    .bulk-btn:hover {
      opacity: 0.9;
    }
    
    .bulk-btn svg {
      width: 14px;
      height: 14px;
    }
    
    .multi-select-toggle {
      display: none;
    }
    
    @media (max-width: 768px) {
      .multi-select-toggle {
        display: flex;
      }
    }

    /* Modals & Overlays */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(2px);
      z-index: 100;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .overlay.open { display: flex; }

    .modal {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.2);
    }

    .modal h2 { font-size: 18px; margin-bottom: 16px; }
    .modal p { color: var(--text-secondary); margin-bottom: 20px; }
    
    .modal input, .modal textarea {
      width: 100%;
      padding: 10px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      margin-bottom: 12px;
      font-family: inherit;
    }

    .modal button {
      width: 100%;
      padding: 10px;
      background: var(--text);
      color: var(--bg);
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
    }

    /* Utilities */
    .loading-state {
      padding: 40px;
      text-align: center;
      color: var(--text-secondary);
    }

    .status-toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--card-bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      z-index: 200;
    }

    .status-toast.visible {
      transform: translateX(-50%) translateY(0);
    }
    
    .shortcuts-help {
        position: fixed;
        bottom: 24px;
        left: 24px;
        font-size: 12px;
        color: var(--text-tertiary);
        pointer-events: none;
        opacity: 0.6;
    }
    
    kbd {
        background: var(--border);
        padding: 2px 4px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 10px;
        color: var(--text);
    }

    @media (max-width: 768px) {
      .app-header { 
          padding: 12px 16px;
          gap: 12px;
      }
      
      .header-top {
          flex-wrap: wrap;
          gap: 12px;
      }
      
      .header-left {
          width: 100%;
          flex-wrap: wrap;
      }
      
      .header-filters {
          width: 100%;
          flex-direction: column;
          align-items: stretch;
      }
      
      .source-dropdown {
          width: 100%;
      }
      
      .dropdown-trigger {
          width: 100%;
          justify-content: space-between;
      }
      
      .category-filters {
          overflow-x: auto;
          flex-wrap: nowrap;
          gap: 6px;
          padding-bottom: 4px;
      }
      
      .category-filters::-webkit-scrollbar {
          display: none;
      }
      
      .category-filter-btn {
          white-space: nowrap;
      }
      
      .app-controls {
          width: 100%;
          justify-content: flex-end;
      }
      
      .shortcuts-help { display: none; }
      .card { 
        padding: 12px 16px; 
        padding-left: 44px;
        flex-wrap: wrap;
      }
      .card-checkbox { top: 12px; left: 12px; }
      .card-source {
        align-self: flex-start;
      }
      .card-content {
        -webkit-line-clamp: 2;
      }
      .card-content-wrapper {
        margin-right: 0;
      }
      .card-meta {
        width: 100%;
        margin-left: 0;
        margin-top: 8px;
        font-size: 12px;
      }
    }
  </style>
</head>
<body>

  <!-- Access Gate -->
  <div id="accessOverlay" class="overlay open">
    <div class="modal">
      <h2>üîê Access Required</h2>
      <p>Please enter your access token to view the feed.</p>
      <input type="password" id="tokenInput" placeholder="Access Token" />
      <div id="tokenError" style="color: var(--error); font-size: 12px; margin-bottom: 10px; display: none;">Invalid token</div>
      <button id="tokenSubmit">Enter</button>
    </div>
  </div>

  <!-- App Layout -->
  <header class="app-header">
    <div class="header-top">
      <div class="header-left">
        <div class="app-logo">
          <i data-lucide="zap" style="width: 18px; height: 18px;"></i>
          <span class="app-logo-text">Factory Feed</span>
        </div>
        
        <div class="header-filters">
          <div class="source-dropdown">
            <button class="dropdown-trigger" id="sourceDropdownBtn">
              <span id="sourceDropdownLabel">All sources</span>
              <i data-lucide="chevron-down" style="width: 14px; height: 14px;"></i>
            </button>
            <div class="dropdown-menu" id="sourceDropdownMenu">
              <div class="dropdown-item selected" data-source="all">
                <div class="dropdown-item-left">
                  <div class="dropdown-checkbox">
                    <i data-lucide="check" style="width: 12px; height: 12px;"></i>
                  </div>
                  <span>All sources</span>
                </div>
                <span class="badge" id="count-all">0</span>
              </div>
              <div class="dropdown-item" data-source="twitter">
                <div class="dropdown-item-left">
                  <div class="dropdown-checkbox"></div>
                  <i data-lucide="twitter" style="width: 14px; height: 14px;"></i>
                  <span>Twitter</span>
                </div>
                <span class="badge" id="count-twitter">0</span>
              </div>
              <div class="dropdown-item" data-source="reddit">
                <div class="dropdown-item-left">
                  <div class="dropdown-checkbox"></div>
                  <i data-lucide="message-square" style="width: 14px; height: 14px;"></i>
                  <span>Reddit</span>
                </div>
                <span class="badge" id="count-reddit">0</span>
              </div>
              <div class="dropdown-item" data-source="github">
                <div class="dropdown-item-left">
                  <div class="dropdown-checkbox"></div>
                  <i data-lucide="github" style="width: 14px; height: 14px;"></i>
                  <span>GitHub</span>
                </div>
                <span class="badge" id="count-github">0</span>
              </div>
            </div>
          </div>
          
          <div class="category-filters">
            <button class="category-filter-btn active" data-category="all" title="All">
              <i data-lucide="layers"></i>
              All
            </button>
            <button class="category-filter-btn" data-category="mention" title="Mentions">
              <i data-lucide="at-sign"></i>
              Mentions
            </button>
            <button class="category-filter-btn" data-category="bug" title="Bugs">
              <i data-lucide="bug"></i>
              Bugs
            </button>
            <button class="category-filter-btn" data-category="love" title="Love">
              <i data-lucide="heart"></i>
              Love
            </button>
            <button class="category-filter-btn" data-category="question" title="Questions">
              <i data-lucide="help-circle"></i>
              Questions
            </button>
          </div>
        </div>
      </div>
      
      <div class="app-controls">
        <button class="icon-btn multi-select-toggle" id="multiSelectToggle" title="Multi-select">
          <i data-lucide="check-square"></i>
        </button>
        <button class="icon-btn" id="refreshBtn" title="Refresh (R)">
          <i data-lucide="refresh-cw"></i>
        </button>
        <button class="icon-btn" id="archiveToggleBtn" title="View Archived">
          <i data-lucide="archive"></i>
        </button>
        <button class="icon-btn" id="themeBtn" title="Toggle Theme">
          <i data-lucide="moon"></i>
        </button>
        <button class="icon-btn" id="settingsBtn" title="Settings">
          <i data-lucide="settings"></i>
        </button>
      </div>
    </div>
  </header>

  <div class="main-wrapper">
    <main class="main-container">
      <div class="feed-container" id="scrollContainer">
        <div id="feedList" class="feed-list">
          <div class="loading-state">Loading feed...</div>
        </div>
      </div>
    </main>
  </div>
  
  <div class="bulk-actions-bar" id="bulkBar">
      <div class="bulk-selection-info">
        <span class="bulk-count" id="bulkCount">0 selected</span>
        <button class="bulk-close" id="clearSelectionBtn" title="Clear Selection (Esc)">
          <i data-lucide="x"></i>
        </button>
      </div>
      <button class="bulk-btn" id="archiveSelectedBtn" title="Archive Selected (E)">
        <i data-lucide="archive"></i>
        Archive
      </button>
  </div>
  
  <div class="shortcuts-help">
    <p><strong>J/K</strong> Nav ‚Ä¢ <strong>X</strong> Select ‚Ä¢ <strong>E</strong> Archive ‚Ä¢ <strong>Shift+A</strong> Select All</p>
  </div>

  <div id="statusToast" class="status-toast">Action completed</div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="overlay">
    <div class="modal" style="max-width: 600px;">
      <h2>Configuration</h2>
      <textarea id="configInput" style="height: 300px; font-family: monospace; font-size: 12px;"></textarea>
      <div style="display: flex; gap: 10px;">
        <button id="saveConfigBtn">Save Changes</button>
        <button id="closeSettingsBtn" style="background: transparent; color: var(--text); border: 1px solid var(--border);">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // Config & Constants
    const ACCESS_TOKEN_HASH = '63fc567c78f3056569ecfdf2ba53cf1955ff86d34d2ab05a3683899e5c642dfe';
    const STORAGE_KEYS = {
      TOKEN: 'factoryAccessToken',
      ARCHIVED: 'factoryArchivedIds',
      CONFIG: 'factoryFeedConfig',
      THEME: 'theme'
    };

    // State
    let state = {
      items: [],
      filteredItems: [],
      archivedIds: new Set(),
      selectedIds: new Set(),
      activeFilter: 'all', // all, twitter, reddit, github
      activeCategory: 'all', // all, mention, bug, love, question, other
      showArchived: false,
      focusedId: null,
      config: {},
      multiSelectMode: false
    };

    // DOM Elements
    const elements = {
      feedList: document.getElementById('feedList'),
      accessOverlay: document.getElementById('accessOverlay'),
      tokenInput: document.getElementById('tokenInput'),
      tokenSubmit: document.getElementById('tokenSubmit'),
      tokenError: document.getElementById('tokenError'),
      sourceDropdownBtn: document.getElementById('sourceDropdownBtn'),
      sourceDropdownMenu: document.getElementById('sourceDropdownMenu'),
      sourceDropdownLabel: document.getElementById('sourceDropdownLabel'),
      categoryFilterBtns: document.querySelectorAll('.category-filter-btn'),
      bulkBar: document.getElementById('bulkBar'),
      bulkCount: document.getElementById('bulkCount'),
      counts: {
        all: document.getElementById('count-all'),
        twitter: document.getElementById('count-twitter'),
        reddit: document.getElementById('count-reddit'),
        github: document.getElementById('count-github')
      },
      toast: document.getElementById('statusToast'),
      settingsModal: document.getElementById('settingsModal'),
      configInput: document.getElementById('configInput'),
      scrollContainer: document.getElementById('scrollContainer')
    };

    // --- Initialization ---
    async function init() {
      loadPersistedState();
      setupTheme();
      setupEventListeners();
      
      // Skip access check for local development
      elements.accessOverlay.classList.remove('open');
      startApp();
    }

    function loadPersistedState() {
      try {
        const archived = JSON.parse(localStorage.getItem(STORAGE_KEYS.ARCHIVED) || '[]');
        state.archivedIds = new Set(archived);
      } catch (e) { console.error(e); }
      
      state.config = getConfig();
    }

    async function startApp() {
      elements.accessOverlay.classList.remove('open');
      await fetchFeed();
      setInterval(fetchFeed, 60000);
    }

    // --- Auth ---
    async function hashToken(token) {
      const encoder = new TextEncoder();
      const data = encoder.encode(token);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      return Array.from(new Uint8Array(hashBuffer))
        .map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function checkAccess() {
      const token = localStorage.getItem(STORAGE_KEYS.TOKEN);
      if (!token) return false;
      return (await hashToken(token)) === ACCESS_TOKEN_HASH;
    }

    elements.tokenSubmit.addEventListener('click', async () => {
      const token = elements.tokenInput.value.trim();
      if ((await hashToken(token)) === ACCESS_TOKEN_HASH) {
        localStorage.setItem(STORAGE_KEYS.TOKEN, token);
        startApp();
      } else {
        elements.tokenError.style.display = 'block';
      }
    });

    elements.tokenInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') elements.tokenSubmit.click();
    });

    // --- Data ---
    async function fetchFeed() {
      try {
        const res = await fetch('./data/feed.json');
        if (!res.ok) throw new Error('Failed to fetch');
        state.items = await res.json();
        
        // Sort by date desc
        state.items.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        render();
      } catch (err) {
        console.error(err);
        showToast('Failed to refresh feed', 'error');
      }
    }

    function getConfig() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEYS.CONFIG) || '{}') || {};
      } catch { return {}; }
    }

    // --- Rendering ---
    function render() {
      // Filter items
      state.filteredItems = state.items.filter(item => {
        const isArchived = state.archivedIds.has(item.id);
        if (state.showArchived !== isArchived) return false;
        
        // Source filter
        if (state.activeFilter !== 'all' && item.source !== state.activeFilter) return false;
        
        // Category filter
        if (state.activeCategory !== 'all') {
            const cat = item.category || item.classification?.label || 'other';
            if (cat !== state.activeCategory) return false;
        }
        
        return true;
      });

      // Update counts
      updateCounts();
      updateBulkBar();

      // Render list
      if (state.filteredItems.length === 0) {
        elements.feedList.innerHTML = '<div class="loading-state">No items found</div>';
        return;
      }

      const html = state.filteredItems.map(item => createCardHTML(item)).join('');
      elements.feedList.innerHTML = html;
      
      // Restore focus
      if (state.focusedId) {
        const el = document.getElementById(`card-${state.focusedId}`);
        if (el) {
            el.classList.add('focused');
        } else {
            state.focusedId = null; 
        }
      }
      
      lucide.createIcons();
      
      // Listeners
      attachCardListeners();
    }
    
    function attachCardListeners() {
        document.querySelectorAll('.card').forEach(card => {
          card.addEventListener('click', (e) => {
             // Avoid double actions if clicking interactive elements
             if (e.target.closest('.card-checkbox')) return;
             if (e.target.tagName === 'A') return;
             
             const id = card.dataset.id;
             focusCard(id);
             
             // In multi-select mode, clicking anywhere selects the post
             if (state.multiSelectMode) {
               toggleSelection(id);
             } else {
               // Otherwise, open the URL
               const url = card.dataset.url;
               if (url) window.open(url, '_blank');
             }
          });
      });
      
      document.querySelectorAll('.card-checkbox').forEach(box => {
          box.addEventListener('click', (e) => {
              e.stopPropagation();
              const id = box.dataset.id;
              toggleSelection(id);
          });
      });
    }

    function createCardHTML(item) {
      const isArchived = state.archivedIds.has(item.id);
      const isSelected = state.selectedIds.has(item.id);
      const date = new Date(item.timestamp);
      const timeAgo = getTimeAgo(date);
      const category = item.category || item.classification?.label || 'other';
      
      let sourceIcon = 'circle';
      if (item.source === 'twitter') sourceIcon = 'twitter';
      if (item.source === 'reddit') sourceIcon = 'message-square';
      if (item.source === 'github') sourceIcon = 'github';
      
      const categoryLabels = {
        mention: 'Mention',
        bug: 'Bug',
        love: 'Love',
        question: 'Question',
        other: 'Other'
      };

      // Build engagement metrics HTML
      let engagementHTML = '';
      if (item.metadata?.likes || item.metadata?.retweets || item.metadata?.replies || item.metadata?.stars) {
        const metrics = [];
        if (item.metadata?.likes) metrics.push(`<span class="engagement-metric"><i data-lucide="heart"></i>${formatNumber(item.metadata.likes)}</span>`);
        if (item.metadata?.retweets) metrics.push(`<span class="engagement-metric"><i data-lucide="repeat"></i>${formatNumber(item.metadata.retweets)}</span>`);
        if (item.metadata?.replies) metrics.push(`<span class="engagement-metric"><i data-lucide="message-circle"></i>${formatNumber(item.metadata.replies)}</span>`);
        if (item.metadata?.stars) metrics.push(`<span class="engagement-metric"><i data-lucide="star"></i>${formatNumber(item.metadata.stars)}</span>`);
        
        if (metrics.length > 0) {
          engagementHTML = `<div class="card-engagement">${metrics.join('')}</div>`;
        }
      }

      return `
        <div class="card ${isArchived ? 'archived' : ''} ${isSelected ? 'selected' : ''}" 
             id="card-${item.id}" 
             data-id="${item.id}" 
             data-url="${item.url}">
          
          <div class="card-checkbox" data-id="${item.id}">
              ${isSelected ? '<i data-lucide="check"></i>' : ''}
          </div>

          <div class="card-source">
            <span class="source-badge source-${item.source}" title="${item.source}">
              <i data-lucide="${sourceIcon}"></i>
            </span>
          </div>
          
          <div class="card-content-wrapper">
            <div class="card-content">${formatContent(item.content)}</div>
          </div>
          
          <div class="card-meta">
            ${engagementHTML}
            <div class="card-meta-item">
              <span class="card-username">${item.author}</span>
            </div>
            <div class="card-meta-item">
              <span class="category-tag category-${category}">
                <i data-lucide="${getCategoryIcon(category)}"></i>
                ${categoryLabels[category]}
              </span>
            </div>
            <div class="card-meta-item">
              <span class="card-time">${timeAgo}</span>
            </div>
          </div>
        </div>
      `;
    }
    
    function updateCounts() {
        const counts = { all: 0, twitter: 0, reddit: 0, github: 0 };
        
        state.items.forEach(item => {
            if (state.archivedIds.has(item.id)) return;
            
            counts.all++;
            if (counts[item.source] !== undefined) counts[item.source]++;
        });
        
        for (const key in counts) {
            if (elements.counts[key]) elements.counts[key].textContent = counts[key];
        }
    }
    
    function updateBulkBar() {
        const count = state.selectedIds.size;
        if (count > 0) {
            elements.bulkBar.classList.add('visible');
            elements.bulkCount.textContent = `${count} selected`;
        } else {
            elements.bulkBar.classList.remove('visible');
        }
    }

    function getCategoryIcon(category) {
        switch(category) {
            case 'mention': return 'at-sign';
            case 'bug': return 'bug';
            case 'love': return 'heart';
            case 'question': return 'help-circle';
            default: return 'archive';
        }
    }

    // --- Actions ---
    function toggleSelection(id) {
        if (state.selectedIds.has(id)) {
            state.selectedIds.delete(id);
        } else {
            state.selectedIds.add(id);
        }
        render();
    }
    
    function selectAllVisible() {
        state.filteredItems.forEach(item => {
            state.selectedIds.add(item.id);
        });
        render();
    }
    
    function clearSelection() {
        state.selectedIds.clear();
        render();
    }
    
    function archiveSelected() {
        const count = state.selectedIds.size;
        if (count === 0) return;
        
        state.selectedIds.forEach(id => {
            state.archivedIds.add(id);
        });
        state.selectedIds.clear();
        localStorage.setItem(STORAGE_KEYS.ARCHIVED, JSON.stringify([...state.archivedIds]));
        
        showToast(`Archived ${count} items`);
        render();
    }

    function toggleArchive(id) {
      if (state.archivedIds.has(id)) {
        state.archivedIds.delete(id);
        showToast('Post unarchived');
      } else {
        state.archivedIds.add(id);
        showToast('Post archived');
        if (state.focusedId === id) moveFocus(1);
      }
      
      localStorage.setItem(STORAGE_KEYS.ARCHIVED, JSON.stringify([...state.archivedIds]));
      render();
    }

    function focusCard(id) {
       if (state.focusedId) {
           document.getElementById(`card-${state.focusedId}`)?.classList.remove('focused');
       }
       state.focusedId = id;
       const el = document.getElementById(`card-${id}`);
       if (el) {
           el.classList.add('focused');
           el.scrollIntoView({ behavior: 'smooth', block: 'center' });
       }
    }

    function moveFocus(direction) {
        if (state.filteredItems.length === 0) return;
        
        let currentIndex = state.filteredItems.findIndex(i => i.id === state.focusedId);
        
        // If no focused item, start from the last selected item
        if (currentIndex === -1 && state.selectedIds.size > 0) {
            const selectedIds = Array.from(state.selectedIds);
            const lastSelectedId = selectedIds[selectedIds.length - 1];
            currentIndex = state.filteredItems.findIndex(i => i.id === lastSelectedId);
        }
        
        if (currentIndex === -1) {
            currentIndex = 0;
        } else {
            currentIndex += direction;
        }
        
        if (currentIndex < 0) currentIndex = 0;
        if (currentIndex >= state.filteredItems.length) currentIndex = state.filteredItems.length - 1;
        
        const item = state.filteredItems[currentIndex];
        if (item) focusCard(item.id);
    }

    function openFocused() {
        if (!state.focusedId) return;
        const item = state.items.find(i => i.id === state.focusedId);
        if (item && item.url) window.open(item.url, '_blank');
    }

    // --- Helpers ---
    function formatContent(text) {
       if (!text) return '';
       return text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" onClick="event.stopPropagation()">$1</a>');
    }

    function formatNumber(num) {
        if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
        return num;
    }

    function getTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        if (seconds < 60) return 'just now';
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `${minutes}m`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours}h`;
        const days = Math.floor(hours / 24);
        return `${days}d`;
    }

    function showToast(msg, type = 'info') {
        elements.toast.textContent = msg;
        elements.toast.classList.add('visible');
        setTimeout(() => elements.toast.classList.remove('visible'), 3000);
    }

    // --- Event Listeners ---
    function setupEventListeners() {
        // Source Dropdown
        elements.sourceDropdownBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            elements.sourceDropdownMenu.classList.toggle('open');
        });
        
        document.addEventListener('click', () => {
            elements.sourceDropdownMenu.classList.remove('open');
        });
        
        elements.sourceDropdownMenu.addEventListener('click', (e) => {
            e.stopPropagation();
        });
        
        document.querySelectorAll('.dropdown-item').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.dropdown-item').forEach(i => i.classList.remove('selected'));
                item.classList.add('selected');
                
                state.activeFilter = item.dataset.source;
                const source = item.dataset.source;
                
                if (source === 'all') {
                    elements.sourceDropdownLabel.textContent = 'All sources';
                } else {
                    elements.sourceDropdownLabel.textContent = source.charAt(0).toUpperCase() + source.slice(1);
                }
                
                state.selectedIds.clear();
                render();
                elements.scrollContainer.scrollTop = 0;
                elements.sourceDropdownMenu.classList.remove('open');
                lucide.createIcons();
            });
        });
        
        // Category Filter Buttons
        elements.categoryFilterBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                elements.categoryFilterBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.activeCategory = btn.dataset.category;
                state.selectedIds.clear();
                render();
                elements.scrollContainer.scrollTop = 0;
            });
        });
        
        // Bulk Actions
        document.getElementById('archiveSelectedBtn').addEventListener('click', archiveSelected);
        document.getElementById('clearSelectionBtn').addEventListener('click', clearSelection);
        
        // Multi-select toggle
        document.getElementById('multiSelectToggle').addEventListener('click', () => {
            state.multiSelectMode = !state.multiSelectMode;
            document.getElementById('multiSelectToggle').classList.toggle('active', state.multiSelectMode);
            if (!state.multiSelectMode) {
                clearSelection();
            }
        });

        // Controls
        document.getElementById('refreshBtn').addEventListener('click', fetchFeed);
        
        document.getElementById('archiveToggleBtn').addEventListener('click', () => {
            state.showArchived = !state.showArchived;
            document.getElementById('archiveToggleBtn').classList.toggle('active');
            render();
        });

        document.getElementById('settingsBtn').addEventListener('click', () => {
            elements.configInput.value = JSON.stringify(state.config, null, 2);
            elements.settingsModal.classList.add('open');
        });

        document.getElementById('closeSettingsBtn').addEventListener('click', () => {
            elements.settingsModal.classList.remove('open');
        });

        document.getElementById('saveConfigBtn').addEventListener('click', () => {
            try {
                const newConfig = JSON.parse(elements.configInput.value);
                localStorage.setItem(STORAGE_KEYS.CONFIG, JSON.stringify(newConfig));
                state.config = newConfig;
                elements.settingsModal.classList.remove('open');
                showToast('Configuration saved');
            } catch {
                alert('Invalid JSON');
            }
        });

        // Keyboard
        document.addEventListener('keydown', e => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            switch(e.key.toLowerCase()) {
                case 'j': moveFocus(1); break;
                case 'k': moveFocus(-1); break;
                case 'e': 
                    if (state.selectedIds.size > 0) {
                        archiveSelected();
                    } else if (state.focusedId) {
                        toggleArchive(state.focusedId); 
                    }
                    break;
                case 'x':
                    if (e.shiftKey) {
                        // Shift+X toggles multi-select mode
                        e.preventDefault();
                        state.multiSelectMode = !state.multiSelectMode;
                        document.getElementById('multiSelectToggle')?.classList.toggle('active', state.multiSelectMode);
                        if (!state.multiSelectMode) {
                            clearSelection();
                        }
                        showToast(state.multiSelectMode ? 'Multi-select mode enabled' : 'Multi-select mode disabled');
                    } else if (state.focusedId) {
                        toggleSelection(state.focusedId);
                    }
                    break;
                case 'escape':
                    if (state.multiSelectMode) {
                        state.multiSelectMode = false;
                        document.getElementById('multiSelectToggle')?.classList.toggle('active', false);
                    }
                    clearSelection();
                    break;
                case 'enter':
                    if (!state.multiSelectMode) {
                        openFocused();
                    }
                    break;
                case 'r':
                    fetchFeed();
                    break;
                case 'arrowdown':
                    e.preventDefault();
                    moveFocus(1);
                    break;
                case 'arrowup':
                    e.preventDefault();
                    moveFocus(-1);
                    break;
            }
        });
    }

    function setupTheme() {
        const themeBtn = document.getElementById('themeBtn');
        const stored = localStorage.getItem(STORAGE_KEYS.THEME);
        if (stored === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
        }

        themeBtn.addEventListener('click', () => {
            const current = document.documentElement.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem(STORAGE_KEYS.THEME, next);
            
            const icon = next === 'dark' ? 'sun' : 'moon';
            themeBtn.innerHTML = `<i data-lucide="${icon}"></i>`;
            lucide.createIcons();
        });
    }

    init();
  </script>
</body>
</html>
